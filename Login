#include <iostream>
#include <fstream>
#include <string>
#include <vector>
#include <sstream>
using namespace std;

struct User {
    string username;
    string password;
    string role;
};

void saveUser(string username, string password, string role) {
    ofstream file("users.txt", ios::app);
    if (file.is_open()) {
        file << username << "," << password << "," << role << endl;
        file.close();
    }
    else {
        cout << "Error! Unable to open the file." << endl;
    }
}

    vector<User> loadUsers() {
        vector<User> users;
        ifstream file("users.txt");
        string line;

    while (getline(file, line)) {
        stringstream ss(line);
        string username, password, role;
        getline(ss, username, ',');
        getline(ss, password, ',');
        getline(ss, role, ',');

        if (role == "User") {
            User user{ username,password };
            users.push_back(user);
       }
    }
    file.close();
    return users;
}

bool userExists(const vector<User>& users, const string& username) {
    for (const auto& user : users) {
        if (user.username == username) return true;
    }
    return false;
}

void userMenu(const string & username) {
    cout << "Welcome to the user Menu!" << endl;
}     // User page

void adminMenu() {
    cout << "Welcome to the admin Menu!" << endl;
}    // Admin page

void registerUser() {
    string username, password;
    vector<User> users = loadUsers();

    cout << "Please enter username:\n";
    cin >> username;

    if (userExists(users,username)) {
        cout << "This username already exits. Please enter another username.\n";
        return;
    }
    cout << "Please enter the password:\n";
    cin >> password;   
    saveUser( username, password, "User");
    cout << "Registration successful!\n";
}

void loginUser() {

    string username, password;
    vector<User> users = loadUsers();
    int attempts = 0;
    const int maxAttempts = 3;

    while (attempts < maxAttempts) {
        cout << "Pleaese enter username:\n";
        cin >> username;
        cout << "Please enter the password:\n";
        cin >> password;

        if (username == "admin" && password == "admin123") {
            cout << "Welcome admin: " << username << endl;
            // Admin page
            adminMenu();
            return;
        }
        bool found = false;
        for (const auto& user : users) {
            if (user.username == username && user.password == password) {
                cout << "Login successful!\n";
                cout << "Welcome user! " << username << endl;
                // User page
                userMenu(username);
                return;
            }
        }
        attempts++;
        if (attempts < maxAttempts){
            cout << "Username or password incorrect. Please try again.\n";
        }
        else {
            cout << "Too many failed attempts.\n";
        }
    }
}

int main() {
    int choice;
    while (true) {
        cout << "\n********************Welcome to Aotearoa Treasures inventory management system********************\n";
        cout << "1. Register\n2. Login\n0. Exits\nPlease enter your choice：\n";
        cin >> choice;

        switch (choice) {
        case 1:
            registerUser();
            break;
        case 2:
            loginUser();
            break;
        case 0:
            cout << "Goodbye！\n";
            return 0;
        default:
            cout << "Invalid option.\n";
        }
    }
    return 0;
}
